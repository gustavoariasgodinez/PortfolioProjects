---
title: "Testing drug effects on blood pressure"
subtitle: "Gustavo Arias Godínez"
author: "M.Sc. Biologist | Data Analyst"
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

____

# 1. Case description
Hypertension (high blood pressure) is a major risk factor for cardiovascular disease. Reducing blood pressure is critical to prevent cardiovascular events. A group of researchers are testing a new drug development used to control high blood pressure in hypertensive patients. Hypertensive individuals were randomly assigned to groups that get no drug (control group), a low dose, medium dose, or high dose.

The main goal of this project is to test statistical differences in blood pressure between patients treated with different drug doses, contrasting the results against the control group.

![<i>Monitoring of blood pressure.</i>](https://www.mayoclinic.org/-/media/kcms/gbs/patient-consumer/images/2018/05/11/14/58/blood-pressure-monitor-8col-3559308-001-0.jpg)

# 2. The data
Data used to run the analyses come from: <a href="https://www.garyfisk.com/pspp/43ANOVA.html">source</a>.

# 3. Import libraries
```{r, message = FALSE, warning = FALSE}
library(tidyverse) # Data manipulation
library(dplyr)     # Data manipulation
library(tidyr)     # Data manipulation
library(ggpubr)    # Data visualization
library(rstatix)   # tidyverse-friendly package to perform t-test, Wilcoxon, ANOVA, KW
library(DT)        # Create data tables
```

# 4. Import data

Here, we will import our data set as a Tibble, an special type of Data Frame given by the tidyverse package. For more information about Tibbles please review the following <a href="https://r4ds.had.co.nz/tibbles.html">documentation</a>.

```{r, message = FALSE}
data <- read_csv("C:/Users/gusta/Documents/Portfolio/R/drug_effects.csv")
class(df)
```

# 5. Data facts

Through the <code>str()</code> function we can get relevant information about our data structure. As shown below, our data set contains four numeric attributes (columns) with ten observations (rows) each.

```{r}
str(data)
```

# 6. Statistical approach

Our main goal is to implement an statistical analysis that enables researchers to determine which of the drug doses is most effective in reducing blood pressure in hypertensive patients.

We can use a one-way Analysis of Variance (one-way ANOVA) to test for statistically significant differences among mean blood pressure (mmHg) between groups. The one-way ANOVA is an extension of the T-test but in a situation where there are more than two groups to be compared.

In its simplest form, an ANOVA model can be represented as follows:

$y_{ij}$ = $\mu_i$ + $\tau_i$ + $\epsilon_{ij}$

Where:

* $y_{ij}$: is the observed response from experimental unit $i$ when receiving treatment $j$.

* $\mu_i$: overall mean value,

* $\tau_i$: treatment effect, and

* $\epsilon_{ij}$: error


# 7. Data preparation

Our data is deployed in four columns, but this layout doesn't explicitly indicate a grouping factor (dose or control). Well, before moving on to our analysis we need to reshape our data from an horizontal to vertical format. The function <code>gather()</code> from the <code>tidyr()</code> package can help us with this task.

```{r}
data <- data %>% gather(key = group,
                          value = bp)

datatable(data = data,
          options = list(pageLength = 5),
          caption = 'Table 1. Blood pressure (mmHg) data from group-randomly-assigned hypertensive patients treated with four drug doses including a no dose (control/placebo) treatment.',
          colnames = c("Group",
                       "Blood pressure (mmHg))"))
```

# 8. Summary

Now that our data has an appropriate format, it is time to run some basic statistics.

```{r}
sts <- data %>%
          group_by(group) %>%
          get_summary_stats(bp, type = 'mean_sd')

datatable(data = sts,
          options = list(pageLength = 5),
          caption = 'Table 2. Mean (± Standard deviation) blood pressure (mmHg) of group-randomly assined hypertensive patients treated with four drug doses including a no dose (control/placebo) treatment.')
```

# 9. Let's take a first look

Here, we'll go to create a box plot to examine preliminary experimental results.

```{r, out.width = '100%'}
ggboxplot(data, x = "group", y = "bp") +
   xlab("Dose") + 
   ylab("Blood pressure (mmHg)") +
  scale_x_discrete(labels=c("control" = "Control",
                            "low_dose" = "Low",
                            "medium_dose" = "Medium",
                            "high_dose" = "High")) +
  geom_boxplot(fill = "steel blue") +
  stat_boxplot(geom = "errorbar", width = 0.2) +
  coord_cartesian(ylim=c(100,200))
```

# 10. Check outliers

The box plot above shows that at least two of the groups present values outside 1.5 times the interquartile range above the upper ($Q1 + 1.5$ * $IQR$) and lower ($Q3 - 1.5$ * $IQR$) quartile. So it is time check if those outliers can be considered 'extreme' with potential negative effects on model performance.

```{r}
data %>% 
  group_by(group) %>%
  identify_outliers(bp)
```

Well, both **high_dose** and **low_dose** groups present outliers, but they are not extreme. So, they can still be considered to feed our one-way ANOVA design.

# 11. Check statistical assumptions

## 11.1. Normality assumption

* **1.** Build the model
* **2.** Analyze the ANOVA model residuals
* **3.** Check normality for each group

### 11.1.1. Build the model

```{r}
# Build the linear model
m1 <- lm(bp ~ group, data = data)
```

### 11.1.2. Analyze model residuals

**Create QQ-plot of residuals:**

```{r, out.width = '100%'}
# Create a QQ plot of residuals
ggqqplot(residuals(m1))
```

**Compute Shapiro-Wilk normality test:**

* **H0** = Residuals are normally distributed
* **H1** = Residuals are not normally distributed

```{r}
# Build the linear model
shapiro_test(residuals(m1))
```

**Conclusion:**

A p-value > 0.05 indicates that there is not enough evidence to reject the null hypothesis (H0); therefore, we assume that residuals are normally distributed.

### 11.1.3. Check normality for each group

**Create QQ-plot of residuals by group:**
```{r, out.width = '100%'}
# Create a QQ plot of residuals by group

new_labels = list(group = c('Control','High dose','Low dose','Medium dose'))

ggqqplot(data, 'bp',
         facet.by = 'group',
         panel.labs = new_labels)
```

**Compute Shapiro-Wilk normality test:**

* **H0** = Residuals are normally distributed
* **H1** = Residuals are not normally distributed

```{r, out.width = '100%'}
data %>%
  group_by(group) %>%
  shapiro_test(bp)
```

**Conclusion:**

All p-values > 0.05 indicates that there are not enough evidence to reject the null hypothesis (H0); therefore, we assume that residuals are normally distributed for all the groups.

## 11.2. Homoscedasticity

Residuals *vs.* Fitted is a common tool to inspect homoscedasticity:
```{r, out.width = '100%'}
plot(m1, 1)
```

The plot above doesn't evidence relationships between residuals and fitted values. However, the ***Levene's*** test is another option to check the homogeneity of variances.

* **H0** = equal variances
* **H1** = unequal variances

```{r, warning = FALSE}
data %>% levene_test(bp ~ group)
```

The p-value is > 0.05. This result means that there is not significant difference between variances across groups, so we can assume the homogeneity of variances.

**Note:** *When the homogeneity of variance assumption is not met, the <b>Welch one-way ANOVA</b> can be used. This test does not require the assumption of equal variances*.

# 12. Model results
```{r}
anova_results <- data %>% anova_test(bp ~ group)
anova_results
```

* **F:** F-test
* **DFn:** Degrees of Freedom in the numerator
* **DFd:** Degrees of Freedon in the denominator
* **p:** p-value
* **ges:** generalized effect size (amount of variability due to the factor)

# 13. Post-Hoc tests

A significant one-way ANOVA is followed up by Tukey post-hoc tests to perform multiple pairwise comparisons between groups.

```{r}
# Pairwise comparisons
pwc <- data %>% tukey_hsd(bp ~ group)
pwc
```

* **estimate:** estimate of the difference between means of the two groups
* **conf.low**, **conf.high:** the lower and the upper end point of the confidence interval at 95% (default)
* **p.adj:** p-value after adjustment for the multiple comparisons.

# 14. Report
```{r, out.width = '100%'}
# Pairwise comparisons
# Visualization: box plots with p-values
pwc <- pwc %>% add_xy_position(x = "group")
ggboxplot(data = data, x = "group", y = "bp") +
  stat_pvalue_manual(pwc, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(anova_results, detailed = TRUE),
    caption = get_pwc_label(pwc)
    )
```